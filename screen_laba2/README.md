# Отчет по лабораторной работе №2
## Лабораторная работа состоит из 3-х частей:
### 1. Настройка работоспособной системы с использованием lvm, raid
### 2. Эмуляция отказа одного из дисков
### 3. Замена дисков на лету, с добавлением новых дисков и переносом разделов.

## Задание 1. Установка ОС и настройка LVM, RAID
#### 1.1 Создайте новую виртуальную машину, выдав ей следующие характеристики:
- 1 gb ram
- 1 cpu
- 2 hdd (назвать их ssd1, ssd2 и назначить равный размер, поставить галочки hot swap и ssd)
- SATA контроллер настроен на 4 порта
- ![](https://pp.userapi.com/c848616/v848616450/199a70/MdKmyIKZBCo.jpg)
- ![](https://pp.userapi.com/c852224/v852224618/123b3c/6_S-AZrjQwI.jpg)
#### 1.2 Выбираем Partitioning method: manual и размечаем диски
- Создаем раздел под /boot с размером 512М
- Для второго диска повторяем настройки, но mount point:none
- ![](https://pp.userapi.com/c852224/v852224618/123b45/EKZ_ZRXb6BU.jpg)
- Настраиваем RAID:
    - Свободное место на обоих дисках используем в качестве типа раздела physical volume for RAID
    - ![](https://pp.userapi.com/c852224/v852224618/123b4e/bDkfY0IdQJ0.jpg)
    - В Configure software RAID создаем MD device, device type: RAID1, выбираем оба диска и их разделы, созданные под RAID
    - ![](https://pp.userapi.com/c852224/v852224618/123b57/tA0J2G_cAqU.jpg)
- Настройка LVM:
  - Keep current partition layout and configure LVM: Yes
  - Create volume group
  - Volume group name: system
  - Devices for the new volume group: Выберите ваш созданный RAID
  - Create logical volume
    - logical volume name: root
    - logical volume size: 2\5 от размера диска
  - Create logical volume
    - logical volume name: var
    - logical volume size: 2\5 от размера диска
  - Create logical volume
    - logical volume name: log
    - logical volume size: 1\5 от размера диска
  - Current LVM configuration:
  - Итог настройки LVM
  - ![](https://pp.userapi.com/c852224/v852224618/123b60/z3kgWOD85l0.jpg)
  - Разметка разделов:
    - root -> Use as: ext4, mount point: /
    - var -> Use as: ext4, mount point: /var
    - log -> Use as: ext4, mount point: /var/log
 - Финальный результат:
 - ![](https://pp.userapi.com/c852224/v852224618/123b69/AUE66-Xx1d0.jpg)
#### 1.3 Закончить установку ОС, поставив grub на первое устройство (sda) и загрузить систему.
#### 1.4 Выполните копирование содержимого раздела /boot с диска sda (ssd1) на диск sdb (ssd2)
#### 1.5 Выполнить установку grub на второе устройство:
- посмотреть диски в системе:
  - fdisk -l
  - lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT
- Перечислите все диски которые вам выдала предыдущая команда и опишите что это за диск
- Найдите диск на который не была выполнена установка grub и выполните эту установку: grub-install /dev/sdb
- просмотрите информацию о текущем raid командой cat /proc/mdstat и запишите что вы увидели.
- посмотрите выводы команд: pvs, vgs, lvs, mount и запишите что именно вы увидели
#### Результат:
# TODO
- В ручную настроенны разделы диска
- Настроенны логические тома (root, var, log), установлены точки монтирования
  
## Задание 2. Эмуляция отказа одного из дисков
  
#### 2.1 Удалить ssd1 в VМ и удалить файл жесткого диска, затем перезагрузить машину
#### 2.2 Проверить статус RAID массива
#### 2.3 Добавляем диск ssd3 и проверяем что за диск пришел в систему:
- Копируем таблицу разделов и смотрим результат
- Добавляем диск в рейд массив
- Смотрим информацию об активных массивах
- Синхронизируем разделы, не входящие в RAID
- Ставим grub на новый диск

#### Результат:
# TODO

## Задание 3. Добавление новых дисков и перенос раздела
#### 3.1 Удаляем ssd2 и смотрим что изменилось
#### 3.2 Добавляем ssd4 и смотрим что изменилось
#### 3.3 Перенос данных с помощью LVM:
- Копируем файловую таблицу
- Копируем данные /boot
- Ставим boot на новый диск
- Установка загрузчика
- Создаем новый RAID- массив для диска
- Смотрим активные массивы
- Смотри информацию о дисках, добавился /dev/md63
#### 3.4 Настройка LVM:
- Смотрим информацию о физических томах
- Создаем новый том с RAID-массивом
- Смотрим что изменилось
- Увеличиваем размер Volume Group System
- Выполняем команды vgdisplay system -v, pvs, vgs, lvs -a -o+devices
- Перемещаем данные на новый диск
- Выполняем команды vgdisplay system -v, pvs, vgsЮ lvs -a -o+devices, lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT
- Удаляем диск старого RAID из логического тома
- Выполняем команды lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT, pvs, vgs
- Перемонтируем /boot на новый диск, проверяем что успешно
#### 3.5 Восстановление работы основного RAID- массива:
- Копируем таблицу разделов
- Копируем /boot
- Устанавливаем grub
#### 3.6 Меняем размер второго размера диска
- Запускаем fdisk, удаляем второй раздел (d 2)
- Создаем новый первичный раздел со вторым номером (n -> p -> 2)
- Выбираем начало и конец раздела по дефолту
- Смотрим список всех возможных типов раздела и находим Linux raid auto (fd)
- Меняем тип созданного раздела, пишем измениния на диск (t -> 2 -> fd -> w)
- Перечитываем таблицу разделов и смотрим результат
- Добавляем диск к RAID- массиву
- Расширяем кол-во дисков в массиве до 2 штук
#### 3.7 Увеличиваем размер раздела на ssd4
- Запускаем fdisk, удаляем второй раздел (d 2)
- Создаем новый первичный раздел со вторым номером (n -> p -> 2)
- Выбираем начало и конец раздела по дефолту
- Оставляем сигнатуру принадлежности раздела к массиву и записываем изменения (No -> w)
- Перечитываем таблицу разделов и смотрим результат
#### 3.8 Разширяем размер RAID
#### 3.9 Меняем размеры vg root,var,log
- Смотрим информацию о физических томах, меняем размер и снова проверяем
- Добавляем место для vg var, root
#### 3.10 Перемещаем /var/log на новые диски
- Смотрим имена дисков
- Создаем RAID- массив
- Создаем физический раздел на рейде, с группой data
- Создаем логический том var_log
- Форматируем новый раздел в ext4
- Смотрим результат
#### 3.11 Перенос логов со старого раздела на новый
- Временно монтируем новое хранилище логов
- Синхронизируем разделы
- Смотрим какие процессы работают с /var/log и останавливаем их
- Финальная синхронизация
- Меняем местами разделы
- Смотрим результат
- Правим таблицу файловой системы и монтируем /var/log на устройство data-var_log
- Ребут и финальная проверка


